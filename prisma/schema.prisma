// Prisma schema for Quản lý thực hiện hợp đồng
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("PRISMA_DATABASE_URL")
  directUrl = env("POSTGRES_URL")
}

// ==========================================
// Module 1: Quản lý người dùng & phân quyền
// ==========================================

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String?  @unique // Required for Passkey - using username@local as email
  emailVerified DateTime? // Required for Passkey
  password  String
  hoTen     String
  role      String   @default("USER2") // ADMIN: Quản trị, USER1: Lãnh đạo, USER2: Người thực hiện
  mustChangePassword Boolean @default(false)
  lastLogin DateTime? // Thời điểm đăng nhập cuối cùng
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Hợp đồng được giao (User1 giao)
  hopDongGiao HopDong[] @relation("NguoiGiao")
  // Hợp đồng thực hiện (User2 thực hiện)
  hopDongThucHien HopDong[] @relation("NguoiThucHien")
  // Hợp đồng được giao thanh toán (User1_TCKT giao việc TT)
  hopDongGiaoThanhToan HopDong[] @relation("NguoiGiaoThanhToan")
  // Hợp đồng được giao thanh toán (User2_TCKT thực hiện)
  hopDongThanhToan HopDong[] @relation("NguoiThanhToan")
  // Passkey/WebAuthn authenticators
  authenticators Authenticator[]
  // Auth accounts (required by PrismaAdapter for Passkey)
  accounts Account[]
  // Notifications
  notifications Notification[]
  // Push subscriptions
  pushSubscriptions PushSubscription[]
}

// ==========================================
// Model Account cho OAuth/Passkey
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// ==========================================
// Model Authenticator cho WebAuthn/Passkey
// ==========================================

model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}

// ==========================================
// Module 2-4: Quản lý Hợp đồng
// ==========================================

model HopDong {
  id        String   @id @default(cuid())
  
  // Thông tin cơ bản (User1 tạo)
  soHopDong       String   @unique
  isFrameworkContract Boolean @default(false) // Là hợp đồng khung
  soHopDongKhung  String?  @unique // Số hợp đồng khung (chỉ dùng khi isFrameworkContract = true)
  
  // Thông tin chi tiết (User2 nhập)
  tenHopDong      String?
  giaTriHopDong   Float?
  ngayKy          DateTime?
  ngayHieuLuc     DateTime?
  hieuLucBaoDam   DateTime?  // Thời hạn bảo đảm thực hiện HĐ
  ngayGiaoHang    DateTime?  // Ngày giao hàng kế hoạch
  tuChinhHopDong  String?    // Thông tin tu chỉnh (nếu có)

  // Relationships
  nguoiGiaoId     String
  nguoiGiao       User     @relation("NguoiGiao", fields: [nguoiGiaoId], references: [id])
  nguoiThucHienId String?
  nguoiThucHien   User?    @relation("NguoiThucHien", fields: [nguoiThucHienId], references: [id])

  // ==========================================
  // Công trình đầu tư xây dựng
  // ==========================================
  isConstructionInvestment Boolean @default(false) // Là hợp đồng công trình đầu tư xây dựng
  giaTriQuyetToan    Float?     // Trị giá quyết toán công trình
  ngayQuyetToan      DateTime?  // Ngày quyết toán

  // ==========================================
  // Module 3: Giao nhận - Nghiệm thu - Thanh toán
  // ==========================================
  giaTriGiaoNhan     Float?     // Giá trị hàng giao nhận
  giaTriNghiemThu    Float?     // Giá trị hàng đã nghiệm thu
  ngayDuyetThanhToan DateTime?  // Ngày duyệt thanh toán

  // ==========================================
  // Module 4: Bảo hành
  // ==========================================
  hanBaoHanh DateTime? // Hạn bảo hành hàng hóa

  // ==========================================
  // Module 5: Thanh toán & Quyết toán (TCKT)
  // ==========================================
  nguoiGiaoThanhToanId  String?  // Người giao việc thanh toán (USER1_TCKT)
  nguoiGiaoThanhToan    User?    @relation("NguoiGiaoThanhToan", fields: [nguoiGiaoThanhToanId], references: [id])
  nguoiThanhToanId      String?
  nguoiThanhToan        User?    @relation("NguoiThanhToan", fields: [nguoiThanhToanId], references: [id])
  giaTriThanhToan       Float?   // Tổng giá trị đã thanh toán (tích lũy, cập nhật nhiều lần)
  daQuyetToan           Boolean  @default(false) // Đánh dấu HĐ đã quyết toán xong
  ngayQuyetToanHoanTat  DateTime? // Ngày xác nhận quyết toán hoàn tất

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// Module 6: Thông báo
// ==========================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String   // "contract_assigned", "contract_released", etc.
  link      String?  // Link để navigate khi click vào thông báo
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, isRead])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fcmToken  String   @unique
  createdAt DateTime @default(now())

  @@index([userId])
}
