// Prisma schema for Quản lý thực hiện hợp đồng
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("PRISMA_DATABASE_URL")
  directUrl = env("POSTGRES_URL")
}

// ==========================================
// Module 1: Quản lý người dùng & phân quyền
// ==========================================

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  hoTen     String
  role      String   @default("USER2") // ADMIN: Quản trị, USER1: Lãnh đạo, USER2: Người thực hiện
  mustChangePassword Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Hợp đồng được giao (User1 giao)
  hopDongGiao HopDong[] @relation("NguoiGiao")
  // Hợp đồng thực hiện (User2 thực hiện)
  hopDongThucHien HopDong[] @relation("NguoiThucHien")
  // Hợp đồng được giao thanh toán (User2_TCKT thực hiện)
  hopDongThanhToan HopDong[] @relation("NguoiThanhToan")
}

// ==========================================
// Module 2-4: Quản lý Hợp đồng
// ==========================================

model HopDong {
  id        String   @id @default(cuid())
  
  // Thông tin cơ bản (User1 tạo)
  soHopDong String   @unique
  
  // Thông tin chi tiết (User2 nhập)
  tenHopDong      String?
  giaTriHopDong   Float?
  ngayKy          DateTime?
  ngayHieuLuc     DateTime?
  hieuLucBaoDam   DateTime?  // Thời hạn bảo đảm thực hiện HĐ
  ngayGiaoHang    DateTime?  // Ngày giao hàng kế hoạch
  tuChinhHopDong  String?    // Thông tin tu chỉnh (nếu có)

  // Relationships
  nguoiGiaoId     String
  nguoiGiao       User     @relation("NguoiGiao", fields: [nguoiGiaoId], references: [id])
  nguoiThucHienId String?
  nguoiThucHien   User?    @relation("NguoiThucHien", fields: [nguoiThucHienId], references: [id])

  // ==========================================
  // Module 3: Giao nhận - Nghiệm thu - Thanh toán
  // ==========================================
  giaTriGiaoNhan     Float?     // Giá trị hàng giao nhận
  giaTriNghiemThu    Float?     // Giá trị hàng đã nghiệm thu
  ngayDuyetThanhToan DateTime?  // Ngày duyệt thanh toán

  // ==========================================
  // Module 4: Bảo hành
  // ==========================================
  hanBaoHanh DateTime? // Hạn bảo hành hàng hóa

  // ==========================================
  // Module 5: Thanh toán (TCKT)
  // ==========================================
  nguoiThanhToanId String?
  nguoiThanhToan   User?    @relation("NguoiThanhToan", fields: [nguoiThanhToanId], references: [id])
  daThanhToan      Boolean  @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
